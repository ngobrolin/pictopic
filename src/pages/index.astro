---
import Layout from "../layouts/Layout.astro";
---

<Layout title="Ngobrolin Web - Podcast Topic Picker">
  <!-- Floating Navbar -->
  <div class="fixed top-4 left-0 right-0 z-50 flex justify-center px-4">
    <nav class="flex w-full max-w-4xl items-center justify-between rounded-full border border-white/10 bg-slate-900/80 px-6 py-3 shadow-lg backdrop-blur-xl">
      <div class="flex items-center gap-3">
        <div class="flex h-10 w-10 items-center justify-center rounded-full bg-gradient-to-tr from-pink-500 to-violet-500 shadow-md">
          <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path>
          </svg>
        </div>
        <span class="text-lg font-bold tracking-tight text-white">Ngobrolin Web</span>
      </div>
      <div class="hidden items-center gap-1 sm:flex">
        <a href="https://github.com/orgs/ngobrolin/discussions" target="_blank" rel="noopener noreferrer" class="rounded-full px-4 py-2 text-sm font-medium text-slate-300 transition-all hover:bg-white/10 hover:text-white">Discussions</a>
        <a href="https://www.youtube.com/@aspect1001" target="_blank" rel="noopener noreferrer" class="rounded-full px-4 py-2 text-sm font-medium text-slate-300 transition-all hover:bg-white/10 hover:text-white">Episodes</a>
      </div>
    </nav>
  </div>

  <main class="mx-auto max-w-7xl px-6 pb-24 pt-32">
    <!-- Header Section -->
    <header class="mb-16 text-center">

      <h1 class="mb-6 text-5xl font-bold tracking-tight text-white md:text-7xl">
        Pick the <span class="hero-gradient">next topic</span>
      </h1>
      <p class="mx-auto max-w-2xl text-xl text-slate-400 font-medium">
        Help us decide what to ramble about next! Vote for the nerdy stuff or let chaos decide.
      </p>
    </header>

    <!-- Random Picker Area (Hero) -->
    <section class="relative mx-auto mb-24 max-w-4xl overflow-hidden rounded-[32px] border border-white/5 bg-[rgba(30,41,59,0.4)] p-1 shadow-2xl backdrop-blur-sm">
      <div class="absolute -top-32 left-1/2 h-64 w-96 -translate-x-1/2 rounded-full bg-pink-500/20 blur-[100px]"></div>
      
      <div id="selected-topic" class="relative flex flex-col items-center justify-center rounded-[28px] border border-white/5 bg-slate-900/50 px-8 py-16 text-center">
        <h2 class="mb-8 mt-2 text-3xl md:text-4xl font-semibold text-slate-500">
          üé≤ No topic selected yet...
        </h2>

        <div class="flex flex-col gap-4 sm:flex-row">
          <button
            id="pick-btn"
            disabled
            class="group relative inline-flex items-center justify-center gap-2 rounded-full bg-white px-8 py-4 text-base font-bold text-slate-900 transition-all hover:-translate-y-1 hover:shadow-[0_10px_30px_-10px_rgba(255,255,255,0.4)] active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:translate-y-0 disabled:hover:shadow-none"
          >
            <svg class="w-5 h-5 transition-transform group-hover:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
            </svg>
            Pick Random Topic
          </button>
          <button
            id="spin-btn"
            disabled
            class="group inline-flex items-center justify-center gap-2 rounded-full border border-white/10 bg-white/5 px-8 py-4 text-base font-semibold text-white transition-all hover:bg-white/10 hover:scale-105 active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed"
          >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
            </svg>
            Spin the Wheel
          </button>
        </div>
      </div>
    </section>

    <!-- Stats Grid -->
    <section class="mb-16 grid grid-cols-2 gap-4 md:grid-cols-4">
      <div class="flex flex-col items-center justify-center rounded-[32px] border border-white/5 bg-[rgba(30,41,59,0.4)] p-6 text-center transition-transform hover:scale-105 hover:-translate-y-2">
        <div id="stat-topics" class="text-4xl font-bold text-[#ec4899]">--</div>
        <div class="mt-1 text-sm font-semibold text-[#94a3b8]">Total Topics</div>
      </div>
      <div class="flex flex-col items-center justify-center rounded-[32px] border border-white/5 bg-[rgba(30,41,59,0.4)] p-6 text-center transition-transform hover:scale-105 hover:-translate-y-2">
        <div id="stat-votes" class="text-4xl font-bold text-[#8b5cf6]">--</div>
        <div class="mt-1 text-sm font-semibold text-[#94a3b8]">Total Votes</div>
      </div>
      <div class="flex flex-col items-center justify-center rounded-[32px] border border-white/5 bg-[rgba(30,41,59,0.4)] p-6 text-center transition-transform hover:scale-105 hover:-translate-y-2">
        <div id="stat-comments" class="text-4xl font-bold text-[#fb923c]">--</div>
        <div class="mt-1 text-sm font-semibold text-[#94a3b8]">Comments</div>
      </div>
      <div class="flex flex-col items-center justify-center rounded-[32px] border border-white/5 bg-[rgba(30,41,59,0.4)] p-6 text-center transition-transform hover:scale-105 hover:-translate-y-2">
        <div id="stat-contributors" class="text-4xl font-bold text-[#22d3ee]">--</div>
        <div class="mt-1 text-sm font-semibold text-[#94a3b8]">Contributors</div>
      </div>
    </section>

    <!-- Filter Bar -->
    <div class="mb-10 flex flex-col justify-between gap-6 pb-2 md:flex-row md:items-center">
      <div>
        <h3 class="flex items-center gap-2 text-2xl font-bold text-white">
          <span class="text-orange-400">üî•</span>
          Hot Topics
          <span id="topics-count" class="text-base font-medium text-slate-500"></span>
        </h3>
      </div>
      
      <div class="flex flex-wrap items-center gap-2">
        <div class="flex flex-wrap gap-2 rounded-2xl bg-slate-800/50 p-1.5">
          <button data-sort="votes" class="sort-btn active rounded-xl px-4 py-2 text-sm font-bold transition-all">
            Most Votes
          </button>
          <button data-sort="comments" class="sort-btn rounded-xl px-4 py-2 text-sm font-semibold text-slate-400 transition-colors hover:bg-white/5 hover:text-white">
            Talked About
          </button>
          <button data-sort="newest" class="sort-btn rounded-xl px-4 py-2 text-sm font-semibold text-slate-400 transition-colors hover:bg-white/5 hover:text-white">
            Fresh
          </button>
          <button data-sort="oldest" class="sort-btn rounded-xl px-4 py-2 text-sm font-semibold text-slate-400 transition-colors hover:bg-white/5 hover:text-white">
            Dusty
          </button>
        </div>
        <button
          id="reset-history-btn"
          class="rounded-xl border border-red-500/30 bg-red-500/10 px-4 py-2 text-sm font-semibold text-red-400 transition-all hover:bg-red-500/20 hidden"
        >
          üóëÔ∏è Reset
        </button>
      </div>
    </div>

    <!-- Topic Grid -->
    <div id="topics-grid" class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
      <!-- Topics will be rendered by JavaScript -->
    </div>
  </main>

  <!-- Footer -->
  <footer class="border-t border-white/5 bg-slate-900/80 py-16 backdrop-blur-lg">
    <div class="mx-auto flex max-w-7xl flex-col items-center justify-between gap-8 px-6 md:flex-row">
      <div class="flex flex-col gap-2">
        <div class="flex items-center gap-2 text-slate-400">
          <span>¬©</span>
          <span class="text-sm font-medium">2024 Ngobrolin Web</span>
        </div>
        <p class="text-xs text-slate-600">Built for fun and profit (mostly fun).</p>
      </div>
      
      <div class="flex gap-4">
        <a href="https://github.com/orgs/ngobrolin/discussions" target="_blank" rel="noopener noreferrer" class="rounded-full bg-white/5 p-3 text-slate-400 hover:bg-white/10 hover:text-white hover:scale-110 transition-all">
          <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
            <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
          </svg>
        </a>
        <a href="https://www.youtube.com/@aspect1001" target="_blank" rel="noopener noreferrer" class="rounded-full bg-white/5 p-3 text-slate-400 hover:bg-white/10 hover:text-white hover:scale-110 transition-all">
          <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
            <path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/>
          </svg>
        </a>
      </div>
    </div>
  </footer>

  <!-- Wheel Modal -->
  <div
    id="wheel-modal"
    class="fixed inset-0 bg-black/80 backdrop-blur-md hidden items-center justify-center z-50"
  >
    <div class="relative mx-4 max-w-lg w-full overflow-hidden rounded-[32px] border border-white/5 bg-[rgba(30,41,59,0.4)] p-1 shadow-2xl backdrop-blur-xl">
      <div class="rounded-[28px] border border-white/5 bg-slate-900/80 p-8">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-2xl font-bold text-white">Spin the Wheel</h3>
          <button
            id="close-modal"
            class="flex h-10 w-10 items-center justify-center rounded-full bg-white/5 text-slate-400 transition-all hover:bg-white/10 hover:text-white hover:scale-110"
          >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>
        <div class="relative">
          <canvas id="wheel-canvas" width="400" height="400" class="mx-auto"></canvas>
          <div class="absolute top-1/2 right-0 transform translate-x-2 -translate-y-1/2">
            <div class="w-0 h-0 border-t-8 border-b-8 border-r-12 border-t-transparent border-b-transparent border-r-white"></div>
          </div>
        </div>
        <div class="text-center mt-8">
          <button
            id="spin-wheel-btn"
            class="group inline-flex items-center justify-center gap-2 rounded-full bg-white px-10 py-4 text-base font-bold text-slate-900 transition-all hover:-translate-y-1 hover:shadow-[0_10px_30px_-10px_rgba(255,255,255,0.4)] active:scale-95"
          >
            üé° Spin!
          </button>
        </div>
        <div id="wheel-result" class="mt-6 text-center hidden">
          <p class="text-xl font-bold hero-gradient"></p>
        </div>
      </div>
    </div>
  </div>
</Layout>

<script>
  import { topics as staticTopics } from "../data/topics";
  import type { Topic } from "../types/topic";
  import * as topicHistory from "../lib/topicHistory";

  const cardColors = [
    { hover: "hover:border-pink-500/50", shadow: "hover:shadow-pink-500/10", text: "group-hover:text-pink-300", btn: "group-hover:bg-pink-400" },
    { hover: "hover:border-cyan-400/50", shadow: "hover:shadow-cyan-400/10", text: "group-hover:text-cyan-300", btn: "group-hover:bg-cyan-400" },
    { hover: "hover:border-emerald-400/50", shadow: "hover:shadow-emerald-400/10", text: "group-hover:text-emerald-300", btn: "group-hover:bg-emerald-400" },
    { hover: "hover:border-purple-400/50", shadow: "hover:shadow-purple-400/10", text: "group-hover:text-purple-300", btn: "group-hover:bg-purple-400" },
    { hover: "hover:border-red-400/50", shadow: "hover:shadow-red-400/10", text: "group-hover:text-red-300", btn: "group-hover:bg-red-400" },
    { hover: "hover:border-indigo-400/50", shadow: "hover:shadow-indigo-400/10", text: "group-hover:text-indigo-300", btn: "group-hover:bg-indigo-400" },
    { hover: "hover:border-blue-400/50", shadow: "hover:shadow-blue-400/10", text: "group-hover:text-blue-300", btn: "group-hover:bg-blue-400" },
    { hover: "hover:border-yellow-400/50", shadow: "hover:shadow-yellow-400/10", text: "group-hover:text-yellow-300", btn: "group-hover:bg-yellow-400" },
    { hover: "hover:border-orange-400/50", shadow: "hover:shadow-orange-400/10", text: "group-hover:text-orange-300", btn: "group-hover:bg-orange-400" },
  ];

  const avatarColors = [
    "bg-blue-400", "bg-orange-400", "bg-green-400", "bg-pink-400", 
    "bg-purple-400", "bg-indigo-400", "bg-cyan-400", "bg-yellow-400"
  ];

  function init() {
    let topics: Topic[] = [];
    let currentSort = "votes";
    let selectedTopicId: number | null = null;

    const pickBtn = document.getElementById("pick-btn") as HTMLButtonElement;
    const spinBtn = document.getElementById("spin-btn") as HTMLButtonElement;
    const selectedTopicDiv = document.getElementById("selected-topic")!;
    const topicsGrid = document.getElementById("topics-grid")!;
    const topicsCount = document.getElementById("topics-count")!;
    const sortBtns = document.querySelectorAll(".sort-btn");
    const resetHistoryBtn = document.getElementById("reset-history-btn")!;
    const wheelModal = document.getElementById("wheel-modal")!;
    const closeModalBtn = document.getElementById("close-modal")!;
    const spinWheelBtn = document.getElementById("spin-wheel-btn")!;
    const wheelCanvas = document.getElementById("wheel-canvas") as HTMLCanvasElement;
    const wheelResult = document.getElementById("wheel-result")!;
    const statTopics = document.getElementById("stat-topics")!;
    const statVotes = document.getElementById("stat-votes")!;
    const statComments = document.getElementById("stat-comments")!;
    const statContributors = document.getElementById("stat-contributors")!;

    function getAvatarColor(author: string): string {
      let hash = 0;
      for (let i = 0; i < author.length; i++) {
        hash = author.charCodeAt(i) + ((hash << 5) - hash);
      }
      return avatarColors[Math.abs(hash) % avatarColors.length];
    }

    function updateStats() {
      statTopics.textContent = topics.length.toString();
      statVotes.textContent = topics.reduce((sum, t) => sum + t.votes, 0).toString();
      statComments.textContent = topics.reduce((sum, t) => sum + t.comments, 0).toString();
      statContributors.textContent = new Set(topics.map((t) => t.author)).size.toString();
    }

    function getUnpickedTopics(): Topic[] {
      const pickedIds = topicHistory.getPickedTopicIds();
      return topics.filter((t) => !pickedIds.includes(t.id));
    }

    function displaySelectedTopic(topic: Topic) {
      const avatarColor = getAvatarColor(topic.author);
      selectedTopicDiv.innerHTML = `
        <div class="absolute -right-2 -top-2 rotate-6 rounded-full bg-gradient-to-r from-pink-500 to-rose-500 px-4 py-1 text-xs font-bold text-white shadow-lg z-10">
          ‚ú® Picked!
        </div>
        <div class="w-full max-w-2xl">
          <h2 class="mb-6 text-3xl md:text-4xl font-bold text-white leading-tight">
            ${topic.title}
          </h2>
          <div class="flex items-center gap-3 mb-8">
            <div class="h-10 w-10 rounded-full border-2 border-slate-700 ${avatarColor}"></div>
            <span class="text-base font-medium text-slate-400">${topic.author}</span>
          </div>
          <div class="flex flex-wrap items-center justify-center gap-4">
            <div class="flex items-center gap-2 rounded-xl bg-pink-500/10 px-4 py-2 text-pink-400">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path>
              </svg>
              <span class="font-bold">${topic.votes} votes</span>
            </div>
            <div class="flex items-center gap-2 rounded-xl bg-slate-700/50 px-4 py-2 text-slate-400">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
              </svg>
              <span class="font-semibold">${topic.comments} comments</span>
            </div>
            <a
              href="${topic.url}"
              target="_blank"
              rel="noopener noreferrer"
              class="flex items-center gap-2 rounded-full bg-white px-6 py-2 text-slate-900 font-bold transition-all hover:scale-105 hover:shadow-lg"
            >
              View Discussion
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path>
              </svg>
            </a>
          </div>
        </div>
        <div class="flex flex-col gap-4 sm:flex-row mt-8">
          <button
            onclick="document.getElementById('pick-btn').click()"
            class="group relative inline-flex items-center justify-center gap-2 rounded-full bg-white px-8 py-4 text-base font-bold text-slate-900 transition-all hover:-translate-y-1 hover:shadow-[0_10px_30px_-10px_rgba(255,255,255,0.4)] active:scale-95"
          >
            <svg class="w-5 h-5 transition-transform group-hover:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
            </svg>
            Pick Another
          </button>
        </div>
      `;
    }

    function displayAllPickedMessage() {
      selectedTopicDiv.innerHTML = `
        <div class="text-center">
          <h2 class="mb-4 text-3xl md:text-4xl font-bold text-white">
            üéâ All topics picked!
          </h2>
          <p class="text-slate-400 text-lg mb-8">You've gone through all the topics. Reset to start fresh!</p>
          <button
            onclick="document.getElementById('reset-history-btn').click()"
            class="inline-flex items-center justify-center gap-2 rounded-full bg-white px-8 py-4 text-base font-bold text-slate-900 transition-all hover:-translate-y-1 hover:shadow-[0_10px_30px_-10px_rgba(255,255,255,0.4)] active:scale-95"
          >
            üîÑ Reset History
          </button>
        </div>
      `;
    }

    function sortTopics(sortBy: string) {
      const sorted = [...topics];
      const pickedIds = topicHistory.getPickedTopicIds();

      switch (sortBy) {
        case "votes":
          sorted.sort((a, b) => b.votes - a.votes);
          break;
        case "comments":
          sorted.sort((a, b) => b.comments - a.comments);
          break;
        case "newest":
          sorted.sort((a, b) => b.id - a.id);
          break;
        case "oldest":
          sorted.sort((a, b) => a.id - b.id);
          break;
      }

      const unpickedCount = sorted.filter(t => !pickedIds.includes(t.id)).length;
      topicsCount.textContent = `(${unpickedCount} of ${sorted.length} available)`;

      topicsGrid.innerHTML = sorted
        .map((topic, index) => {
          const isPicked = pickedIds.includes(topic.id);
          const isSelected = topic.id === selectedTopicId;
          const color = cardColors[index % cardColors.length];
          const avatarColor = getAvatarColor(topic.author);
          
          if (isPicked) {
            return `
              <div
                class="group relative flex flex-col justify-between rounded-[32px] border-2 border-pink-500/50 bg-slate-800/40 p-6 opacity-60 transition-all"
                data-topic-id="${topic.id}"
              >
                <div class="absolute -right-2 -top-2 rotate-6 rounded-full bg-gradient-to-r from-pink-500 to-rose-500 px-4 py-1 text-xs font-bold text-white shadow-lg">
                  ‚ú® Picked!
                </div>
                <div>
                  <h4 class="mb-3 text-2xl font-bold leading-tight text-white transition-colors">
                    ${topic.title}
                  </h4>
                  <div class="flex items-center gap-3">
                    <div class="h-8 w-8 rounded-full border-2 border-slate-700 ${avatarColor}"></div>
                    <span class="text-sm font-medium text-slate-400">${topic.author}</span>
                  </div>
                </div>
                <div class="mt-8 rounded-2xl bg-slate-900/50 p-2">
                  <div class="flex items-center justify-between">
                    <div class="flex items-center gap-1 pl-2">
                      <div class="flex items-center gap-1.5 rounded-lg bg-pink-500/10 px-3 py-1.5 text-pink-400">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path>
                        </svg>
                        <span class="text-sm font-bold">${topic.votes}</span>
                      </div>
                      <div class="flex items-center gap-1.5 px-3 py-1.5 text-slate-500">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                        </svg>
                        <span class="text-sm font-semibold">${topic.comments}</span>
                      </div>
                    </div>
                    <a href="${topic.url}" target="_blank" rel="noopener noreferrer" onclick="event.stopPropagation()" class="flex h-10 w-10 items-center justify-center rounded-full bg-pink-400 text-slate-900 shadow-sm transition-transform hover:scale-110">
                      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path>
                      </svg>
                    </a>
                  </div>
                </div>
              </div>
            `;
          }
          
          return `
            <div
              class="group relative flex flex-col justify-between rounded-[32px] border border-white/5 bg-slate-800/40 p-6 transition-all hover:-translate-y-2 ${color.hover} hover:shadow-xl ${color.shadow} cursor-pointer ${isSelected ? 'ring-2 ring-pink-500' : ''}"
              data-topic-id="${topic.id}"
            >
              <div>
                <h4 class="mb-3 text-2xl font-bold leading-tight text-slate-100 ${color.text} transition-colors">
                  ${topic.title}
                </h4>
                <div class="flex items-center gap-3">
                  <div class="h-8 w-8 rounded-full border-2 border-slate-700 ${avatarColor}"></div>
                  <span class="text-sm font-medium text-slate-400">${topic.author}</span>
                </div>
              </div>
              <div class="mt-8 rounded-2xl bg-slate-900/50 p-2">
                <div class="flex items-center justify-between">
                  <div class="flex items-center gap-1 pl-2">
                    <div class="flex items-center gap-1.5 rounded-lg hover:bg-white/5 px-3 py-1.5 text-slate-300 transition-colors">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path>
                      </svg>
                      <span class="text-sm font-bold">${topic.votes}</span>
                    </div>
                    <div class="flex items-center gap-1.5 px-3 py-1.5 text-slate-500">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                      </svg>
                      <span class="text-sm font-semibold">${topic.comments}</span>
                    </div>
                  </div>
                  <a href="${topic.url}" target="_blank" rel="noopener noreferrer" onclick="event.stopPropagation()" class="flex h-10 w-10 items-center justify-center rounded-full bg-slate-700 text-white transition-all ${color.btn} group-hover:text-slate-900 hover:scale-110">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path>
                    </svg>
                  </a>
                </div>
              </div>
            </div>
          `;
        })
        .join("");
    }

    function pickRandomTopic() {
      const unpickedTopics = getUnpickedTopics();

      if (unpickedTopics.length === 0) {
        displayAllPickedMessage();
        updateResetButtonVisibility();
        return;
      }

      const cards = topicsGrid.querySelectorAll(".topic-card:not(.opacity-60), [data-topic-id]:not(.opacity-60)");
      const unpickedCards = Array.from(cards).filter(card => {
        const id = parseInt(card.getAttribute("data-topic-id") || "0");
        return unpickedTopics.some(t => t.id === id);
      });
      
      if (unpickedCards.length === 0) {
        const randomTopic = unpickedTopics[Math.floor(Math.random() * unpickedTopics.length)];
        selectedTopicId = randomTopic.id;
        topicHistory.addPickedTopic(randomTopic.id);
        displaySelectedTopic(randomTopic);
        sortTopics(currentSort);
        updateResetButtonVisibility();
        return;
      }

      let iterations = 0;
      const maxIterations = 20;
      const interval = setInterval(() => {
        unpickedCards.forEach((card) => {
          card.classList.remove("ring-2", "ring-pink-500", "scale-105");
        });

        const randomIndex = Math.floor(Math.random() * unpickedCards.length);
        const randomCard = unpickedCards[randomIndex];
        randomCard.classList.add("ring-2", "ring-pink-500", "scale-105");

        iterations++;
        if (iterations >= maxIterations) {
          clearInterval(interval);
          const topicId = parseInt(randomCard.getAttribute("data-topic-id") || "0");
          selectedTopicId = topicId;
          const topic = topics.find((t) => t.id === topicId);
          if (topic) {
            topicHistory.addPickedTopic(topicId);
            displaySelectedTopic(topic);
            randomCard.scrollIntoView({ behavior: "smooth", block: "center" });
            sortTopics(currentSort);
            updateResetButtonVisibility();
          }
        }
      }, 100);
    }

    const colors = [
      "#ec4899", "#8b5cf6", "#22d3ee", "#34d399", "#fb923c",
      "#eab308", "#f472b6", "#a78bfa", "#38bdf8", "#4ade80",
    ];

    function drawWheel(topicsToDraw: Topic[] = topics, rotation = 0) {
      if (topicsToDraw.length === 0) return;

      const ctx = wheelCanvas.getContext("2d");
      if (!ctx) return;

      const centerX = wheelCanvas.width / 2;
      const centerY = wheelCanvas.height / 2;
      const radius = Math.min(centerX, centerY) - 10;
      const sliceAngle = (2 * Math.PI) / topicsToDraw.length;

      ctx.clearRect(0, 0, wheelCanvas.width, wheelCanvas.height);
      ctx.save();
      ctx.translate(centerX, centerY);
      ctx.rotate(rotation);

      topicsToDraw.forEach((topic, index) => {
        const startAngle = index * sliceAngle;
        const endAngle = startAngle + sliceAngle;

        ctx.beginPath();
        ctx.moveTo(0, 0);
        ctx.arc(0, 0, radius, startAngle, endAngle);
        ctx.closePath();
        ctx.fillStyle = colors[index % colors.length];
        ctx.fill();
        ctx.strokeStyle = "#0f172a";
        ctx.lineWidth = 3;
        ctx.stroke();

        ctx.save();
        ctx.rotate(startAngle + sliceAngle / 2);
        ctx.textAlign = "right";
        ctx.fillStyle = "white";
        ctx.font = "600 11px Outfit, sans-serif";
        const text = topic.title.length > 20 ? topic.title.substring(0, 17) + "..." : topic.title;
        ctx.fillText(text, radius - 15, 4);
        ctx.restore();
      });

      ctx.restore();

      ctx.beginPath();
      ctx.arc(centerX, centerY, 25, 0, 2 * Math.PI);
      ctx.fillStyle = "#0f172a";
      ctx.fill();
      ctx.strokeStyle = "white";
      ctx.lineWidth = 3;
      ctx.stroke();
    }

    let isSpinning = false;

    function spinWheel() {
      const unpickedTopics = getUnpickedTopics();

      if (unpickedTopics.length === 0) {
        displayAllPickedMessage();
        wheelModal.classList.add("hidden");
        wheelModal.classList.remove("flex");
        return;
      }

      if (isSpinning) return;
      isSpinning = true;
      wheelResult.classList.add("hidden");

      const spinDuration = 5000;
      const spinRevolutions = 5 + Math.random() * 5;
      const targetRotation = spinRevolutions * 2 * Math.PI;
      const startTime = Date.now();

      function animate() {
        const elapsed = Date.now() - startTime;
        const progress = Math.min(elapsed / spinDuration, 1);
        const easeOut = 1 - Math.pow(1 - progress, 3);
        const currentRotation = targetRotation * easeOut;

        drawWheel(unpickedTopics, currentRotation);

        if (progress < 1) {
          requestAnimationFrame(animate);
        } else {
          isSpinning = false;
          const sliceAngle = (2 * Math.PI) / unpickedTopics.length;
          const normalizedRotation = currentRotation % (2 * Math.PI);
          const selectedIndex = Math.floor((2 * Math.PI - normalizedRotation) / sliceAngle) % unpickedTopics.length;
          const selectedTopic = unpickedTopics[selectedIndex];

          const resultP = wheelResult.querySelector("p");
          if (resultP) resultP.textContent = selectedTopic.title;
          wheelResult.classList.remove("hidden");

          selectedTopicId = selectedTopic.id;
          topicHistory.addPickedTopic(selectedTopic.id);
          displaySelectedTopic(selectedTopic);

          setTimeout(() => {
            sortTopics(currentSort);
            updateResetButtonVisibility();
          }, 1000);
        }
      }

      animate();
    }

    function resetHistory() {
      if (confirm("Are you sure you want to reset the pick history? This will allow all topics to be picked again.")) {
        topicHistory.clearHistory();
        selectedTopicId = null;
        sortTopics(currentSort);
        selectedTopicDiv.innerHTML = `
          <h2 class="mb-8 mt-2 text-3xl md:text-4xl font-semibold text-slate-500">
            üé≤ No topic selected yet...
          </h2>
          <div class="flex flex-col gap-4 sm:flex-row">
            <button
              onclick="document.getElementById('pick-btn').click()"
              class="group relative inline-flex items-center justify-center gap-2 rounded-full bg-white px-8 py-4 text-base font-bold text-slate-900 transition-all hover:-translate-y-1 hover:shadow-[0_10px_30px_-10px_rgba(255,255,255,0.4)] active:scale-95"
            >
              <svg class="w-5 h-5 transition-transform group-hover:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
              </svg>
              Pick Random Topic
            </button>
            <button
              onclick="document.getElementById('spin-btn').click()"
              class="group inline-flex items-center justify-center gap-2 rounded-full border border-white/10 bg-white/5 px-8 py-4 text-base font-semibold text-white transition-all hover:bg-white/10 hover:scale-105 active:scale-95"
            >
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
              </svg>
              Spin the Wheel
            </button>
          </div>
        `;
        updateResetButtonVisibility();
      }
    }

    function updateResetButtonVisibility() {
      const pickedCount = topicHistory.getPickedTopicIds().length;
      if (pickedCount > 0) {
        resetHistoryBtn.classList.remove("hidden");
      } else {
        resetHistoryBtn.classList.add("hidden");
      }
    }

    pickBtn.addEventListener("click", pickRandomTopic);

    spinBtn.addEventListener("click", () => {
      wheelModal.classList.remove("hidden");
      wheelModal.classList.add("flex");
      drawWheel(getUnpickedTopics());
    });

    closeModalBtn.addEventListener("click", () => {
      wheelModal.classList.add("hidden");
      wheelModal.classList.remove("flex");
    });

    wheelModal.addEventListener("click", (e) => {
      if (e.target === wheelModal) {
        wheelModal.classList.add("hidden");
        wheelModal.classList.remove("flex");
      }
    });

    spinWheelBtn.addEventListener("click", spinWheel);
    resetHistoryBtn.addEventListener("click", resetHistory);

    sortBtns.forEach((btn) => {
      btn.addEventListener("click", () => {
        const sortBy = btn.getAttribute("data-sort") || "votes";
        currentSort = sortBy;

        sortBtns.forEach((b) => {
          b.classList.remove("active", "bg-pink-500", "text-white", "shadow-lg", "shadow-pink-500/20");
          b.classList.add("text-slate-400");
        });
        btn.classList.add("active", "bg-pink-500", "text-white", "shadow-lg", "shadow-pink-500/20");
        btn.classList.remove("text-slate-400");

        sortTopics(sortBy);
      });
    });

    // Initialize first sort button style
    const firstSortBtn = document.querySelector('[data-sort="votes"]');
    if (firstSortBtn) {
      firstSortBtn.classList.add("bg-pink-500", "text-white", "shadow-lg", "shadow-pink-500/20");
      firstSortBtn.classList.remove("text-slate-400");
    }

    topics = staticTopics;
    updateStats();
    sortTopics(currentSort);
    updateResetButtonVisibility();
    pickBtn.disabled = false;
    spinBtn.disabled = false;
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", init);
  } else {
    init();
  }
</script>
