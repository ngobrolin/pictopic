---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Ngobrolin Web - Topic Picker">
  <main class="container mx-auto px-4 py-12 max-w-6xl">
    <!-- Header -->
    <header class="text-center mb-12">
      <h1 class="text-5xl font-bold mb-4 bg-gradient-to-r from-purple-400 via-pink-400 to-purple-400 bg-clip-text text-transparent">
        Ngobrolin Web
      </h1>
      <p class="text-xl text-slate-400">Pick the next topic for our podcast discussion</p>
    </header>

    <!-- Picker Section -->
    <section class="mb-12">
      <div class="bg-white/5 backdrop-blur-sm rounded-2xl p-8 border border-white/10">
        <div class="text-center mb-6">
          <h2 class="text-2xl font-semibold mb-2">Random Topic Picker</h2>
          <p class="text-slate-400">Click the button to randomly select the next discussion topic</p>
        </div>

        <!-- Selected Topic Display -->
        <div id="selected-topic" class="mb-6 min-h-32 flex items-center justify-center">
          <p class="text-slate-500 italic">No topic selected yet</p>
        </div>

        <!-- Picker Button -->
        <div class="flex justify-center gap-4">
          <button
            id="pick-btn"
            disabled
            class="px-8 py-4 bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-500 hover:to-pink-500 rounded-xl font-semibold text-lg transition-all duration-300 hover:scale-105 hover:shadow-lg hover:shadow-purple-500/25 active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100"
          >
            Pick Random Topic
          </button>
          <button
            id="spin-btn"
            disabled
            class="px-8 py-4 bg-gradient-to-r from-amber-600 to-orange-600 hover:from-amber-500 hover:to-orange-500 rounded-xl font-semibold text-lg transition-all duration-300 hover:scale-105 hover:shadow-lg hover:shadow-amber-500/25 active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100"
          >
            Spin the Wheel
          </button>
        </div>
      </div>
    </section>

    <!-- Stats -->
    <section class="mb-8">
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div class="bg-white/5 rounded-xl p-4 text-center border border-white/10">
          <div id="stat-topics" class="text-3xl font-bold text-purple-400">--</div>
          <div class="text-sm text-slate-400">Total Topics</div>
        </div>
        <div class="bg-white/5 rounded-xl p-4 text-center border border-white/10">
          <div id="stat-votes" class="text-3xl font-bold text-pink-400">--</div>
          <div class="text-sm text-slate-400">Total Votes</div>
        </div>
        <div class="bg-white/5 rounded-xl p-4 text-center border border-white/10">
          <div id="stat-comments" class="text-3xl font-bold text-amber-400">--</div>
          <div class="text-sm text-slate-400">Total Comments</div>
        </div>
        <div class="bg-white/5 rounded-xl p-4 text-center border border-white/10">
          <div id="stat-contributors" class="text-3xl font-bold text-emerald-400">--</div>
          <div class="text-sm text-slate-400">Contributors</div>
        </div>
      </div>
    </section>

    <!-- Sort Controls -->
    <section class="mb-6">
      <div class="flex flex-wrap gap-2 items-center">
        <span class="text-slate-400 mr-2">Sort by:</span>
        <button data-sort="votes" class="sort-btn px-4 py-2 rounded-lg bg-purple-600/30 border border-purple-500/50 text-sm hover:bg-purple-600/50 transition-colors">
          Most Votes
        </button>
        <button data-sort="comments" class="sort-btn px-4 py-2 rounded-lg bg-white/5 border border-white/10 text-sm hover:bg-white/10 transition-colors">
          Most Comments
        </button>
        <button data-sort="newest" class="sort-btn px-4 py-2 rounded-lg bg-white/5 border border-white/10 text-sm hover:bg-white/10 transition-colors">
          Newest
        </button>
        <button data-sort="oldest" class="sort-btn px-4 py-2 rounded-lg bg-white/5 border border-white/10 text-sm hover:bg-white/10 transition-colors">
          Oldest
        </button>
      </div>
    </section>

    <!-- Topics Grid -->
    <section>
      <h2 class="text-2xl font-semibold mb-6">All Topics</h2>
      <div id="topics-grid" class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
        <!-- Topics will be rendered by JavaScript -->
      </div>
    </section>

    <!-- Footer -->
    <footer class="mt-16 text-center text-slate-500 text-sm">
      <p>
        Topics sourced from
        <a href="https://github.com/orgs/ngobrolin/discussions" target="_blank" rel="noopener noreferrer" class="text-purple-400 hover:text-purple-300 transition-colors">
          GitHub Discussions
        </a>
      </p>
    </footer>
  </main>

  <!-- Wheel Modal -->
  <div id="wheel-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden items-center justify-center z-50">
    <div class="bg-slate-900 rounded-2xl p-8 max-w-lg w-full mx-4 border border-white/10">
      <div class="flex justify-between items-center mb-6">
        <h3 class="text-xl font-semibold">Spin the Wheel</h3>
        <button id="close-modal" class="text-slate-400 hover:text-white transition-colors">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      <div class="relative">
        <canvas id="wheel-canvas" width="400" height="400" class="mx-auto"></canvas>
        <div class="absolute top-1/2 right-0 transform translate-x-2 -translate-y-1/2">
          <div class="w-0 h-0 border-t-8 border-b-8 border-r-12 border-t-transparent border-b-transparent border-r-white"></div>
        </div>
      </div>
      <div class="text-center mt-6">
        <button id="spin-wheel-btn" class="px-8 py-3 bg-gradient-to-r from-amber-600 to-orange-600 hover:from-amber-500 hover:to-orange-500 rounded-xl font-semibold transition-all duration-300 hover:scale-105">
          Spin!
        </button>
      </div>
      <div id="wheel-result" class="mt-4 text-center hidden">
        <p class="text-lg font-semibold text-amber-400"></p>
      </div>
    </div>
  </div>
</Layout>

<script>
  import { topics as staticTopics } from '../data/topics';
  import type { Topic } from '../types/topic';

  // Initialize when DOM is ready
  function init() {
    // State
    let topics: Topic[] = [];
    let currentSort = 'votes';
    let selectedTopicId: number | null = null;

    // DOM Elements
    const pickBtn = document.getElementById('pick-btn') as HTMLButtonElement;
    const spinBtn = document.getElementById('spin-btn') as HTMLButtonElement;
    const selectedTopicDiv = document.getElementById('selected-topic') as HTMLDivElement;
    const topicsGrid = document.getElementById('topics-grid') as HTMLDivElement;
    const sortBtns = document.querySelectorAll('.sort-btn');
    const wheelModal = document.getElementById('wheel-modal') as HTMLDivElement;
    const closeModalBtn = document.getElementById('close-modal') as HTMLButtonElement;
    const spinWheelBtn = document.getElementById('spin-wheel-btn') as HTMLButtonElement;
    const wheelCanvas = document.getElementById('wheel-canvas') as HTMLCanvasElement;
    const wheelResult = document.getElementById('wheel-result') as HTMLDivElement;
    const statTopics = document.getElementById('stat-topics') as HTMLDivElement;
    const statVotes = document.getElementById('stat-votes') as HTMLDivElement;
    const statComments = document.getElementById('stat-comments') as HTMLDivElement;
    const statContributors = document.getElementById('stat-contributors') as HTMLDivElement;

    // Update stats
  function updateStats() {
    statTopics.textContent = topics.length.toString();
    statVotes.textContent = topics.reduce((sum, t) => sum + t.votes, 0).toString();
    statComments.textContent = topics.reduce((sum, t) => sum + t.comments, 0).toString();
    statContributors.textContent = new Set(topics.map(t => t.author)).size.toString();
  }

  // Render topic card HTML
  function renderTopicCard(topic: Topic): string {
    const isSelected = selectedTopicId === topic.id;
    return `
      <div
        class="topic-card p-4 rounded-xl border transition-all duration-300 cursor-pointer ${
          isSelected
            ? 'bg-purple-600/40 border-purple-400 shadow-lg shadow-purple-500/20 scale-105'
            : 'bg-white/5 border-white/10 hover:bg-white/10 hover:border-white/20'
        }"
        data-topic-id="${topic.id}"
      >
        <h3 class="font-semibold text-lg mb-2 text-white">${topic.title}</h3>
        <div class="flex items-center gap-4 text-sm text-slate-400">
          <span class="flex items-center gap-1">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
            </svg>
            ${topic.author}
          </span>
          <span class="flex items-center gap-1">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
            </svg>
            ${topic.votes}
          </span>
          <span class="flex items-center gap-1">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
            </svg>
            ${topic.comments}
          </span>
        </div>
        <a
          href="${topic.url}"
          target="_blank"
          rel="noopener noreferrer"
          class="inline-block mt-3 text-sm text-purple-400 hover:text-purple-300 transition-colors"
          onclick="event.stopPropagation()"
        >
          View Discussion â†’
        </a>
      </div>
    `;
  }

  // Sort and render topics
  function sortTopics(sortBy: string) {
    const sortedTopics = [...topics].sort((a, b) => {
      switch (sortBy) {
        case 'votes':
          return b.votes - a.votes;
        case 'comments':
          return b.comments - a.comments;
        case 'newest':
          return b.id - a.id;
        case 'oldest':
          return a.id - b.id;
        default:
          return 0;
      }
    });

    topicsGrid.innerHTML = sortedTopics.map(renderTopicCard).join('');
  }

  // Display selected topic
  function displaySelectedTopic(topic: Topic) {
    selectedTopicDiv.innerHTML = `
      <div class="bg-gradient-to-r from-purple-600/30 to-pink-600/30 rounded-xl p-6 border border-purple-400/50 w-full">
        <div class="flex items-center gap-2 mb-2">
          <svg class="w-6 h-6 text-amber-400" fill="currentColor" viewBox="0 0 24 24">
            <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
          </svg>
          <span class="text-amber-400 font-medium">Selected Topic</span>
        </div>
        <h3 class="text-2xl font-bold mb-3">${topic.title}</h3>
        <div class="flex items-center gap-4 text-slate-300 mb-4">
          <span>by ${topic.author}</span>
          <span>${topic.votes} votes</span>
          <span>${topic.comments} comments</span>
        </div>
        <a href="${topic.url}" target="_blank" rel="noopener noreferrer"
           class="inline-flex items-center gap-2 px-4 py-2 bg-white/10 rounded-lg hover:bg-white/20 transition-colors">
          Open Discussion
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
          </svg>
        </a>
      </div>
    `;
  }

  // Random picker with animation
  function pickRandomTopic() {
    if (topics.length === 0) return;

    const cards = document.querySelectorAll('.topic-card');
    let iterations = 0;
    const maxIterations = 20;
    const interval = setInterval(() => {
      cards.forEach(card => {
        card.classList.remove('bg-purple-600/40', 'border-purple-400', 'shadow-lg', 'shadow-purple-500/20', 'scale-105');
        card.classList.add('bg-white/5', 'border-white/10');
      });

      const randomIndex = Math.floor(Math.random() * cards.length);
      const randomCard = cards[randomIndex];
      randomCard.classList.remove('bg-white/5', 'border-white/10');
      randomCard.classList.add('bg-purple-600/40', 'border-purple-400', 'shadow-lg', 'shadow-purple-500/20', 'scale-105');

      iterations++;
      if (iterations >= maxIterations) {
        clearInterval(interval);
        const topicId = parseInt(randomCard.getAttribute('data-topic-id') || '0');
        selectedTopicId = topicId;
        const topic = topics.find(t => t.id === topicId);
        if (topic) {
          displaySelectedTopic(topic);
          randomCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
      }
    }, 100);
  }

  // Wheel functionality
  const colors = [
    '#8b5cf6', '#ec4899', '#f59e0b', '#10b981', '#3b82f6',
    '#ef4444', '#06b6d4', '#84cc16', '#f97316', '#6366f1'
  ];

  function drawWheel(rotation = 0) {
    if (topics.length === 0) return;

    const ctx = wheelCanvas.getContext('2d');
    if (!ctx) return;

    const centerX = wheelCanvas.width / 2;
    const centerY = wheelCanvas.height / 2;
    const radius = Math.min(centerX, centerY) - 10;
    const sliceAngle = (2 * Math.PI) / topics.length;

    ctx.clearRect(0, 0, wheelCanvas.width, wheelCanvas.height);
    ctx.save();
    ctx.translate(centerX, centerY);
    ctx.rotate(rotation);

    topics.forEach((topic, index) => {
      const startAngle = index * sliceAngle;
      const endAngle = startAngle + sliceAngle;

      ctx.beginPath();
      ctx.moveTo(0, 0);
      ctx.arc(0, 0, radius, startAngle, endAngle);
      ctx.closePath();
      ctx.fillStyle = colors[index % colors.length];
      ctx.fill();
      ctx.strokeStyle = '#1e1b4b';
      ctx.lineWidth = 2;
      ctx.stroke();

      ctx.save();
      ctx.rotate(startAngle + sliceAngle / 2);
      ctx.textAlign = 'right';
      ctx.fillStyle = 'white';
      ctx.font = 'bold 10px sans-serif';
      const text = topic.title.length > 20 ? topic.title.substring(0, 17) + '...' : topic.title;
      ctx.fillText(text, radius - 10, 4);
      ctx.restore();
    });

    ctx.restore();

    ctx.beginPath();
    ctx.arc(centerX, centerY, 20, 0, 2 * Math.PI);
    ctx.fillStyle = '#1e1b4b';
    ctx.fill();
    ctx.strokeStyle = 'white';
    ctx.lineWidth = 2;
    ctx.stroke();
  }

  let isSpinning = false;

  function spinWheel() {
    if (isSpinning || topics.length === 0) return;
    isSpinning = true;
    wheelResult.classList.add('hidden');

    const spinDuration = 5000;
    const spinRevolutions = 5 + Math.random() * 5;
    const targetRotation = spinRevolutions * 2 * Math.PI;
    const startTime = Date.now();

    function animate() {
      const elapsed = Date.now() - startTime;
      const progress = Math.min(elapsed / spinDuration, 1);
      const easeOut = 1 - Math.pow(1 - progress, 3);
      const currentRotation = targetRotation * easeOut;

      drawWheel(currentRotation);

      if (progress < 1) {
        requestAnimationFrame(animate);
      } else {
        isSpinning = false;
        const sliceAngle = (2 * Math.PI) / topics.length;
        const normalizedRotation = currentRotation % (2 * Math.PI);
        const selectedIndex = Math.floor((2 * Math.PI - normalizedRotation) / sliceAngle) % topics.length;
        const selectedTopic = topics[selectedIndex];

        wheelResult.querySelector('p')!.textContent = selectedTopic.title;
        wheelResult.classList.remove('hidden');

        selectedTopicId = selectedTopic.id;
        displaySelectedTopic(selectedTopic);
        sortTopics(currentSort);
      }
    }

    animate();
  }

  // Event listeners
  pickBtn.addEventListener('click', pickRandomTopic);

  spinBtn.addEventListener('click', () => {
    wheelModal.classList.remove('hidden');
    wheelModal.classList.add('flex');
    drawWheel();
  });

  closeModalBtn.addEventListener('click', () => {
    wheelModal.classList.add('hidden');
    wheelModal.classList.remove('flex');
  });

  wheelModal.addEventListener('click', (e) => {
    if (e.target === wheelModal) {
      wheelModal.classList.add('hidden');
      wheelModal.classList.remove('flex');
    }
  });

  spinWheelBtn.addEventListener('click', spinWheel);

  sortBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      const sortBy = btn.getAttribute('data-sort') || 'votes';
      currentSort = sortBy;

      sortBtns.forEach(b => {
        b.classList.remove('bg-purple-600/30', 'border-purple-500/50');
        b.classList.add('bg-white/5', 'border-white/10');
      });
      btn.classList.remove('bg-white/5', 'border-white/10');
      btn.classList.add('bg-purple-600/30', 'border-purple-500/50');

      sortTopics(sortBy);
    });
  });

    // Load static topics immediately
    topics = staticTopics;
    updateStats();
    sortTopics(currentSort);
    drawWheel();
    pickBtn.disabled = false;
    spinBtn.disabled = false;
  }

  // Run init when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
</script>

<style>
  .border-r-12 {
    border-right-width: 12px;
  }
</style>
